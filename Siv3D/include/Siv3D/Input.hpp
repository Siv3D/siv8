//-----------------------------------------------
//
//	This file is part of the Siv3D Engine.
//
//	Copyright (c) 2008-2025 Ryo Suzuki
//	Copyright (c) 2016-2025 OpenSiv3D Project
//
//	Licensed under the MIT License.
//
//-----------------------------------------------

# pragma once
# include "Common.hpp"
# include "InputDeviceType.hpp"
# include "Duration.hpp"
# include "String.hpp"

namespace s3d
{
	class InputCombination;
	class InputGroup;

	////////////////////////////////////////////////////////////////
	//
	//	Input
	//
	////////////////////////////////////////////////////////////////

	/// @brief 入力オブジェクト
	/// @remark キーボード、マウスのボタン、ゲームパッドのボタンなど、押下できる入力装置の要素を表現します。
	class Input
	{
	public:

		////////////////////////////////////////////////////////////////
		//
		//	(constructor)
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		Input() = default;

		[[nodiscard]]
		constexpr Input(InputDeviceType device, uint8 code, uint8 playerIndex = 0) noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	deviceType
		//
		////////////////////////////////////////////////////////////////

		/// @brief デバイスの種類を返します。
		/// @return デバイスの種類
		[[nodiscard]]
		constexpr InputDeviceType deviceType() const noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	code
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		constexpr uint8 code() const noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	playerIndex
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		constexpr uint8 playerIndex() const noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	name
		//
		////////////////////////////////////////////////////////////////

		/// @brief 入力オブジェクトの名前を返します。
		/// @return 入力オブジェクトの名前
		[[nodiscard]] 
		String name() const;

		////////////////////////////////////////////////////////////////
		//
		//	down, pressed, up
		//
		////////////////////////////////////////////////////////////////

		/// @brief 入力オブジェクトが現在のフレームで押され始めたかを返します。
		/// @return 入力オブジェクトが現在のフレームで押され始めた場合 true, それ以外の場合は false
		[[nodiscard]]
		bool down() const;

		/// @brief 入力オブジェクトが押されているかを返します。
		/// @return 入力オブジェクトが押されている場合 true, それ以外の場合は false
		[[nodiscard]]
		bool pressed() const;

		/// @brief 入力オブジェクトが現在のフレームで離されたかを返します。
		/// @return 入力オブジェクトが現在のフレームで離された場合 true, それ以外の場合は false
		[[nodiscard]]
		bool up() const;

		////////////////////////////////////////////////////////////////
		//
		//	clearInput
		//
		////////////////////////////////////////////////////////////////

		/// @brief 現在のフレームで、以降の down() と pressed() を強制的に false にします。
		void clearInput() const;

		////////////////////////////////////////////////////////////////
		//
		//	isCleared
		//
		////////////////////////////////////////////////////////////////

		/// @brief 現在のフレームで clearInput() が呼ばれたかを返します。
		/// @return 現在のフレームで clearInput() が呼ばれている場合 true, それ以外の場合は false
		[[nodiscard]]
		bool isCleared() const;

		////////////////////////////////////////////////////////////////
		//
		//	pressedDuration
		//
		////////////////////////////////////////////////////////////////

		/// @brief 入力オブジェクトが押され続けている時間を返します。
		/// @remark `up()` が true を返すフレームまで計測結果は有効なため、`if (KeyA.up()) Print << KeyA.pressedDuration()` と書けます。
		/// @return 入力オブジェクトが押され続けている時間
		[[nodiscard]] 
		Duration pressedDuration() const;

		////////////////////////////////////////////////////////////////
		//
		//	operator +
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		constexpr InputCombination operator +(Input other) const noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	operator |
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		InputGroup operator |(Input other) const;
		
		[[nodiscard]]
		InputGroup operator |(const InputCombination& other) const;

		[[nodiscard]]
		InputGroup operator |(const InputGroup& other) const;

		////////////////////////////////////////////////////////////////
		//
		//	asUint32
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		constexpr uint32 asUint32() const noexcept;

		////////////////////////////////////////////////////////////////
		//
		//	operator ==
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		friend constexpr bool operator ==(Input lhs, Input rhs) noexcept
		{
			return (lhs.asUint32() == rhs.asUint32());
		}

		////////////////////////////////////////////////////////////////
		//
		//	operator <=>
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		friend constexpr auto operator <=>(Input lhs, Input rhs) noexcept
		{
			return (lhs.asUint32() <=> rhs.asUint32());
		}

		////////////////////////////////////////////////////////////////
		//
		//	operator <<
		//
		////////////////////////////////////////////////////////////////

		template <class CharType>
		friend std::basic_ostream<CharType>& operator <<(std::basic_ostream<CharType>& output, const Input& value)
		{
			return output << value.name();
		}

		////////////////////////////////////////////////////////////////
		//
		//	Formatter
		//
		////////////////////////////////////////////////////////////////

		/// @brief 入力オブジェクトを文字列に変換します。
		/// @param formatData 文字列バッファ
		/// @param value 入力オブジェクト
		/// @remark この関数は Format 用の関数です。通常、ユーザーが直接呼び出す必要はありません。
		friend void Formatter(FormatData& formatData, const Input& value);

		////////////////////////////////////////////////////////////////
		//
		//	Serialize
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		static String Serialize(const Input& input);

		////////////////////////////////////////////////////////////////
		//
		//	Deserialize
		//
		////////////////////////////////////////////////////////////////

		[[nodiscard]]
		static Input Deserialize(StringView s);

	private:

		InputDeviceType m_device = InputDeviceType::Unknown;

		uint8 m_code = 0;

		uint8 m_playerIndex = 0;

		uint8 m_reserved = 0;
	};
}
